---
title: "Association, partitionnement et ordination"
author: "Serge-√âtienne Parent"
date: "`r format(Sys.Date())`"
output: github_document
---

# Association, partitionnement et ordination {#chapitre-ordination}

```{r}
library("tidyverse")
```


## Espaces d'analyse

### Abondance et occurence

L'abondance est le d√©compte d'esp√®ces observ√©es, tandis que l'occurence est la pr√©sence ou l'absence d'une esp√®ce. Le tableau suivant contient des donn√©es d'abondance.

```{r}
abundance <- data_frame('Bruant familier' = c(1, 0, 0, 3),
                        'Citelle √† poitrine rousse' = c(1, 0, 0, 0),
                        'Colibri √† gorge rubis' = c(0, 1, 0, 0),
                        'Geai bleu' = c(3, 2, 0, 0),
                        'Bruant chanteur' = c(1, 0, 5, 2),
                        'Chardonneret' = c(0, 9, 6, 0),
                        'Bruant √† gorge blanche' = c(1, 0, 0, 0),
                        'M√©sange √† t√™te noire' = c(20, 1, 1, 0),
                        'Jaseur bor√©al' = c(66, 0, 0, 0))
```

Ce tableau peut √™tre rapidement transform√© en donn√©es d'occurence, qui ne comprennent que l'information bool√©enne de pr√©sence (not√© 1) et d'absence (not√© 0).

```{r}
occurence <- abundance %>%
  transmute_all(funs(if_else(. > 0, 1, 0)))
occurence
```

L'**espace des esp√®ces** (ou des variables ou descripteurs) est celui o√π les esp√®ces forment les axes et o√π les sites sont positionn√©s dans cet espace. Il s'agit d'une perspective en *mode R*, qui permet principalement d'identifier quels esp√®ces se retrouvent plus courrament ensemble.


```{r}
library("scatterplot3d")
species <- c("Bruant chanteur", "Chardonneret", "M√©sange √† t√™te noire")
x <- abundance %>% pull(species[1])
y <- abundance %>% pull(species[2])
z <- abundance %>% pull(species[3])
scatterplot3d(x, y, z, angle = 20, asp = 0.3,
              xlab = species[1], ylab = species[2], zlab = species[3])
```

Dans l'**espace des sites** (ou les √©chantillons ou objets), on transpose la matrice d'abondance. On passe ici en *mode Q*, o√π chaque point est une esp√®ce, et o√π l'on peut observer quels √©chantillons sont similaires.

```{r}
site1 <- t(abundance)[, 1]
site2 <- t(abundance)[, 2]
site3 <- t(abundance)[, 3]
scatterplot3d(site1, site2, site3, angle = 20, asp = 10,
              xlab = "Site 1", ylab = "Site 2", zlab = "Site 3")
```

### Environnement

L'**espace de l'environnement** comprend souvent un autre tableau contenant l'information sur l'environnement o√π se trouve les esp√®ces: les coordonn√©es et l'√©l√©vation, la pente, le pH du sol, la pluviom√©trie, etc.

## Analyse d'association

Nous utiliserons le terme *association* come une **mesure pour quantifier la ressemblance ou la diff√©rence entre deux objets (√©chantillons) ou variables (descripteurs)**.

Alors que la corr√©lation et la covariance sont des mesures d'association entre des variables (analyse en *mode R*), la **similarit√©** et la **distance** sont deux types de une mesure d'association entre des objets (analyse en *mode Q*). Une distance de 0 est mesur√© chez deux objets identiques. La distance augmente au fur et √† mesure que les objets sont dissoci√©s. Une similarit√© ayant une valeur de 0 indique aucune association, tandis qu'une valeur de 1 indique une association parfaite. √Ä l'oppos√©, la dissimilarit√© est √©gale √† 1-similarit√©.

La distance peut √™tre li√©e √† la similarit√© par la relation:

$$distance=\sqrt{1-similarit√©}$$

ou

$$distance=\sqrt{dissimilarit√©}$$

La racine carr√©e permet, pour certains indices de similarit√©, d'obtenir des propri√©t√©s eucl√©diennes. Pour plus de d√©tails, voyez le tableau 7.2 de [Legendre et Legendre (2012)](https://www.elsevier.com/books/numerical-ecology/legendre/978-0-444-53868-0).

Les matrices d'association sont g√©n√©ralement pr√©sent√©es comme des matrices carr√©es, dont les dimensions sont √©gales au nombre d'objets (*mode Q*) ou de vrariables (*mode R*) dans le tableau. Chaque √©l√©ment ("cellule") de la matrice est un indice d'association entre un objet (ou une variable) et un autre. Ainsi, la diagonale de la matrice est un vecteur nul (distance ou dissimilarit√©) ou unitaire (similarit√©), car elle correspond √† l'association entre un objet et lui-m√™me. 

Puisque l'association entre A et B est la m√™me qu'entre B et A, et puisque la diagonale retourne une valeur convenue, il est possible d'exprimer une matrice d'association en mode "compact", sous forme de vecteur. Le vecteur d'association entre des objets A, B et C contiendra toute l'information n√©cessaire en un vecteur de trois chiffres, `[AB, AC, BC]`, plut√¥t qu'une matrice de dimension $3 \times 3$. L'impact sur la m√©moire vive peut √™tre consid√©rable pour les calculs comprenant de nombreuses dimensions.

En R, les calculs de similarit√© et de distances peuvent √™tre effectu√©s avec le module `vegan`. La fonction `vegdist` permet de calculer les indices d'association en forme carr√©e.

Nous verons plus tard les m√©thodes de mesure de similarit√© et de distance plus loin. Pour l'instant, utilisons la m√©thode de *Jaccard* pour une d√©monstration sur des donn√©es d'occurence.

```{r}
library("vegan")
vegdist(occurence, method = "jaccard",
        diag = TRUE, upper = TRUE)
```

Remarquez que `vegdist` retourne une matrice dont la diagonale est de 0 (on l'affiche en sp√©cifiant `diag = TRUE`). La diagonale est l'association d'un objet avec lui-m√™me. Or la similarit√© d'un objet avec lui-m√™me devrait √™tre de 1! En fait, par convention `vegdist` retourne des dissimilarit√©s, non pas des similarit√©s. La matrice de distance serait donc calcul√©e en extrayant la racine carr√©e des √©l√©ments de la matrice de dissimilarit√©:

```{r}
dissimilarity <- vegdist(occurence, method = "jaccard",
                        diag = TRUE, upper = TRUE)
distance <- sqrt(dissimilarity)
distance
```

Dans le chapitre sur l'analyse compositionnelle, nous avons abord√© les significations diff√©rentes que peuvent prendre le z√©ro. L'information fournie par un z√©ro peut √™tre diff√©rente selon les circonstances. Dans le cas d'une variable continue, un z√©ro signifie g√©n√©ralement une mesure sous le seuil de d√©tection. Deux tissus dont la concentration en cuivre est nulle ont une afinit√© sous la perspective de la concentration en cuivre. Dans le cas de mesures d'abondance (d√©compte) ou d'occurence (pr√©sence-absence), on pourra d√©crire comme similaires deux niches √©cologiques o√π l'on retrouve une esp√®ce en particulier. Mais deux sites o√π l'on de retouve pas d'ours polaires ne correspondent pas n√©cessairement √† des niches similaires! En effet, il peut exister de nombreuses raisons √©cologiques et m√©thodologiques pour lesquelles l'esp√®ces ou les esp√®ces n'ont pas √©t√© observ√©es. C'est le probl√®me des **double-z√©ros** (esp√®ces non observ√©es √† deux sites), probl√®me qui est amplifi√© avec les grilles comprenant des esp√®ces rares.

La ressemblance entre des objets comprenant des donn√©es continues devrait √™tre calcul√©e gr√¢ce √† des indicateurs *sym√©triques*. Inversement, les affinit√©s entre les objets d√©crits par des donn√©es d'abondance ou d'occurence susceptibles de g√©n√©rer des probl√®mes de double-z√©ros devraient √™tre √©valu√©es gr√¢ce √† des indicateurs *asym√©triques*. Un d√©fi suppl√©mentaire arrive lorsque les donn√©es sont de type mixte.

Nous utiliserons la convention de `scipy` et nous calculerons la dissimilarit√©, non pas la similarit√©. Les mesures de dissimilarit√© sont calcul√©es sur des donn√©es d'abondance ou des donn√©es d'occurence. Notons qu'il existe beaucoup de confusion dans la litt√©rature sur la mani√®re de nommer les dissimilarit√©s (ce qui n'est pas le cas des distances, dont les noms sont reconnus). Dans les sections suivantes, nous noterons la dissimilarit√© avec un $d$ minuscule et la distance avec un $D$ majuscule.

### Association entre objets (mode Q)

#### Objets: Abondance

La **dissimilarit√© de Bray-Curtis** est asym√©trique. Elle est aussi appel√©e l'indice de Steinhaus, de Czekanowski ou de S√∏rensen. Il est important de s'assurer de bien s'entendre la m√©thode √† laquelle on fait r√©f√©rence. L'√©quation enl√®ve toute ambiguit√©. La dissimilarit√© de Bray-Curtis entre les points A et B est calcul√©e comme suit.

$$d_{AB} =  \frac {\sum \left| A_{i} - B_{i} \right| }{\sum \left(A_{i}+B_{i}\right)}$$

Utilisons `vegdist` pour g√©n√©rer les matrices d'association. Le format "liste" de R est pratique pour enregistrer la collection d'objets, dont les matrice d'association que nous allons cr√©er dans cette section.

```{r}
associations_abund <- list()
associations_abund[['BrayCurtis']] <- vegdist(abundance, method = "bray")
associations_abund[['BrayCurtis']]
```

La dissimilarit√© de Bray-Curtis est souvent utilis√©e dans la litt√©rature. Toutefois, la version originale de Bray-Curtis n'est pas tout √† fait m√©trique (semim√©trique). Cons√©quemment, la **dissimilarit√© de Ruzicka** (une variante de la dissimilarit√© de Jaccard pour les donn√©es d'abondance) est m√©trique, et devrait probablement √™tre pr√©f√©r√© √† Bary-Curtis ([Oksanen, 2006](http://ocw.um.es/ciencias/geobotanica/otros-recursos-1/documentos/vegantutorial.pdf)).

$$d_{AB, Ruzicka} =  \frac { 2 \times d_{AB, Bray-Curtis} }{1 + d_{AB, Bray-Curtis}}$$

```{r}
associations_abund[['Ruzicka']] <- associations_abund[['BrayCurtis']] * 2 / (1 + associations_abund[['BrayCurtis']])
```

La **dissimilarit√© de Kulczynski** (aussi √©crit Kulsinski) est asym√©trique et semim√©trique, tout comme celle de Bray-Curtis. Elle est calcul√©e comme suit.

$$d_{AB} = 1-\frac{1}{2} \times \left[ \frac{\sum min(A_i, B_i)}{\sum A_i} + \frac{\sum min(A_i, B_i)}{\sum B_i} \right]$$

```{r}
associations_abund[['Kulczynski']] <- vegdist(abundance, method = "kulczynski")
```

Une approche commune pour mesurer l'association entre sites d√©crits par des donn√©es d'abondance est la **distance de Hellinger**. Notez qu'il s'agit ici d'une distance, non pas d'une dissimilarit√©. Pour l'obtenir, on doit d'abord diviser chaque donn√©e d'abondance par l'abondance totale pour chaque site pour obtenir les esp√®ces en tant que proportions, puis on extrait la racine carr√©e de chaque √©l√©ment. Enfin, on calcule la distance euclidienne entre les proportions de chaque site. Pour rappel, une distance euclidienne est la g√©n√©ralisation en plusieurs dimensions du th√©or√®me de Pythagore, $c = \sqrt{a^2 + b^2}$.

$$D_{AB} = \sqrt {\sum \left( \frac{A_i}{\sum A_i} - \frac{B_i}{\sum B_i} \right)^2}$$

------------------ -----------------------------------------------
üò±\ **Attention**   La distance d'Hellinger h√©rite des biais li√©es aux donn√©es compositionnelles. Elle peut √™tre substiti√©e par une matrice de distances d'Aitchison.

------------------------------------------------------------------

```{r}
associations_abund[['Hellinger']] <- dist(decostand(abundance, method="hellinger"))
```

Toute comme la distance d'Hellinger, la **distance de chord** est calcul√©e par une distance euclidienne sur des donn√©es d'abondance transform√©es de sorte que chaque ligne ait une longueur (norme) de 1.

```{r}
associations_abund[['Chord']] <- dist(decostand(abundance, method="normalize"))
```

La **m√©trique du chi-carr√©**, ou $\chi$-carr√©, ou chi-square, donne davantage de poids aux esp√®ces rares qu'aux esp√®ces communes. Son utilisation est recommand√©e lorsque les esp√®ces rares sont de bons indicateurs de conditions √©cologiques particuli√®res ([Legendre et Legendre, 2012](https://www.elsevier.com/books/numerical-ecology/legendre/978-0-444-53868-0), p. 308).

$$  d_{AB} = \sqrt{\sum _j \frac{1}{\sum y_j} \left( \frac{A_j}{\sum A} - \frac{B_j}{\sum B} \right)^2 }  $$

La m√©trique peut √™tre transform√©e en distance en la multipliant par la racine carr√©e de la somme totale des esp√®ces dans la matric d'abondance ($X$).

$$ D_{AB} = \sqrt{\sum X} \times d_{AB} $$


```{r}
associations_abund[['ChiSquare']] <- dist(decostand(abundance, method="chi.square"))
```

Une manni√®re visuellement plus int√©ressante de pr√©senter une matrice d'association est un graphique de type *heatmap*.

```
library("pheatmap")
par(mfrow = c(2, 3))
for (i in seq_along(associations_abund)) {
  pheatmap(associations_abund[[i]],
         cluster_rows = FALSE, cluster_cols = FALSE, legend = TRUE,
         display_numbers = TRUE)
}

```