---
title: "Association, partitionnement et ordination"
author: "Serge-√âtienne Parent"
date: "`r format(Sys.Date())`"
output: github_document
---

# Association, partitionnement et ordination {#chapitre-ordination}

```{r}
library("tidyverse")
```


## Espaces d'analyse

### Abondance et occurence

L'abondance est le d√©compte d'esp√®ces observ√©es, tandis que l'occurence est la pr√©sence ou l'absence d'une esp√®ce. Le tableau suivant contient des donn√©es d'abondance.

```{r}
abundance <- tibble('Bruant familier' = c(1, 0, 0, 3),
                        'Citelle √† poitrine rousse' = c(1, 0, 0, 0),
                        'Colibri √† gorge rubis' = c(0, 1, 0, 0),
                        'Geai bleu' = c(3, 2, 0, 0),
                        'Bruant chanteur' = c(1, 0, 5, 2),
                        'Chardonneret' = c(0, 9, 6, 0),
                        'Bruant √† gorge blanche' = c(1, 0, 0, 0),
                        'M√©sange √† t√™te noire' = c(20, 1, 1, 0),
                        'Jaseur bor√©al' = c(66, 0, 0, 0))
```

Ce tableau peut √™tre rapidement transform√© en donn√©es d'occurence, qui ne comprennent que l'information bool√©enne de pr√©sence (not√© 1) et d'absence (not√© 0).

```{r}
occurence <- abundance %>%
  transmute_all(funs(if_else(. > 0, 1, 0)))
occurence
```

L'**espace des esp√®ces** (ou des variables ou descripteurs) est celui o√π les esp√®ces forment les axes et o√π les sites sont positionn√©s dans cet espace. Il s'agit d'une perspective en *mode R*, qui permet principalement d'identifier quels esp√®ces se retrouvent plus courrament ensemble.


```{r}
library("scatterplot3d")
species <- c("Bruant chanteur", "Chardonneret", "M√©sange √† t√™te noire")
x <- abundance %>% pull(species[1])
y <- abundance %>% pull(species[2])
z <- abundance %>% pull(species[3])
scatterplot3d(x, y, z, angle = 20, asp = 0.3,
              xlab = species[1], ylab = species[2], zlab = species[3])
```

Dans l'**espace des sites** (ou les √©chantillons ou objets), on transpose la matrice d'abondance. On passe ici en *mode Q*, o√π chaque point est une esp√®ce, et o√π l'on peut observer quels √©chantillons sont similaires.

```{r}
site1 <- t(abundance)[, 1]
site2 <- t(abundance)[, 2]
site3 <- t(abundance)[, 3]
scatterplot3d(site1, site2, site3, angle = 20, asp = 10,
              xlab = "Site 1", ylab = "Site 2", zlab = "Site 3")
```

### Environnement

L'**espace de l'environnement** comprend souvent un autre tableau contenant l'information sur l'environnement o√π se trouve les esp√®ces: les coordonn√©es et l'√©l√©vation, la pente, le pH du sol, la pluviom√©trie, etc.

## Analyse d'association

Nous utiliserons le terme *association* come une **mesure pour quantifier la ressemblance ou la diff√©rence entre deux objets (√©chantillons) ou variables (descripteurs)**.

Alors que la corr√©lation et la covariance sont des mesures d'association entre des variables (analyse en *mode R*), la **similarit√©** et la **distance** sont deux types de une mesure d'association entre des objets (analyse en *mode Q*). Une distance de 0 est mesur√© chez deux objets identiques. La distance augmente au fur et √† mesure que les objets sont dissoci√©s. Une similarit√© ayant une valeur de 0 indique aucune association, tandis qu'une valeur de 1 indique une association parfaite. √Ä l'oppos√©, la dissimilarit√© est √©gale √† 1-similarit√©.

La distance peut √™tre li√©e √† la similarit√© par la relation:

$$distance=\sqrt{1-similarit√©}$$

ou

$$distance=\sqrt{dissimilarit√©}$$

La racine carr√©e permet, pour certains indices de similarit√©, d'obtenir des propri√©t√©s eucl√©diennes. Pour plus de d√©tails, voyez le tableau 7.2 de [Legendre et Legendre (2012)](https://www.elsevier.com/books/numerical-ecology/legendre/978-0-444-53868-0).

Les matrices d'association sont g√©n√©ralement pr√©sent√©es comme des matrices carr√©es, dont les dimensions sont √©gales au nombre d'objets (*mode Q*) ou de vrariables (*mode R*) dans le tableau. Chaque √©l√©ment ("cellule") de la matrice est un indice d'association entre un objet (ou une variable) et un autre. Ainsi, la diagonale de la matrice est un vecteur nul (distance ou dissimilarit√©) ou unitaire (similarit√©), car elle correspond √† l'association entre un objet et lui-m√™me. 

Puisque l'association entre A et B est la m√™me qu'entre B et A, et puisque la diagonale retourne une valeur convenue, il est possible d'exprimer une matrice d'association en mode "compact", sous forme de vecteur. Le vecteur d'association entre des objets A, B et C contiendra toute l'information n√©cessaire en un vecteur de trois chiffres, `[AB, AC, BC]`, plut√¥t qu'une matrice de dimension $3 \times 3$. L'impact sur la m√©moire vive peut √™tre consid√©rable pour les calculs comprenant de nombreuses dimensions.

En R, les calculs de similarit√© et de distances peuvent √™tre effectu√©s avec le module `vegan`. La fonction `vegdist` permet de calculer les indices d'association en forme carr√©e.

Nous verons plus tard les m√©thodes de mesure de similarit√© et de distance plus loin. Pour l'instant, utilisons la m√©thode de *Jaccard* pour une d√©monstration sur des donn√©es d'occurence.

```{r}
library("vegan")
vegdist(occurence, method = "jaccard",
        diag = TRUE, upper = TRUE)
```

Remarquez que `vegdist` retourne une matrice dont la diagonale est de 0 (on l'affiche en sp√©cifiant `diag = TRUE`). La diagonale est l'association d'un objet avec lui-m√™me. Or la similarit√© d'un objet avec lui-m√™me devrait √™tre de 1! En fait, par convention `vegdist` retourne des dissimilarit√©s, non pas des similarit√©s. La matrice de distance serait donc calcul√©e en extrayant la racine carr√©e des √©l√©ments de la matrice de dissimilarit√©:

```{r}
dissimilarity <- vegdist(occurence, method = "jaccard",
                        diag = TRUE, upper = TRUE)
distance <- sqrt(dissimilarity)
distance
```

Dans le chapitre sur l'analyse compositionnelle, nous avons abord√© les significations diff√©rentes que peuvent prendre le z√©ro. L'information fournie par un z√©ro peut √™tre diff√©rente selon les circonstances. Dans le cas d'une variable continue, un z√©ro signifie g√©n√©ralement une mesure sous le seuil de d√©tection. Deux tissus dont la concentration en cuivre est nulle ont une afinit√© sous la perspective de la concentration en cuivre. Dans le cas de mesures d'abondance (d√©compte) ou d'occurence (pr√©sence-absence), on pourra d√©crire comme similaires deux niches √©cologiques o√π l'on retrouve une esp√®ce en particulier. Mais deux sites o√π l'on de retouve pas d'ours polaires ne correspondent pas n√©cessairement √† des niches similaires! En effet, il peut exister de nombreuses raisons √©cologiques et m√©thodologiques pour lesquelles l'esp√®ces ou les esp√®ces n'ont pas √©t√© observ√©es. C'est le probl√®me des **double-z√©ros** (esp√®ces non observ√©es √† deux sites), probl√®me qui est amplifi√© avec les grilles comprenant des esp√®ces rares.

La ressemblance entre des objets comprenant des donn√©es continues devrait √™tre calcul√©e gr√¢ce √† des indicateurs *sym√©triques*. Inversement, les affinit√©s entre les objets d√©crits par des donn√©es d'abondance ou d'occurence susceptibles de g√©n√©rer des probl√®mes de double-z√©ros devraient √™tre √©valu√©es gr√¢ce √† des indicateurs *asym√©triques*. Un d√©fi suppl√©mentaire arrive lorsque les donn√©es sont de type mixte.

Nous utiliserons la convention de `scipy` et nous calculerons la dissimilarit√©, non pas la similarit√©. Les mesures de dissimilarit√© sont calcul√©es sur des donn√©es d'abondance ou des donn√©es d'occurence. Notons qu'il existe beaucoup de confusion dans la litt√©rature sur la mani√®re de nommer les dissimilarit√©s (ce qui n'est pas le cas des distances, dont les noms sont reconnus). Dans les sections suivantes, nous noterons la dissimilarit√© avec un $d$ minuscule et la distance avec un $D$ majuscule.

### Association entre objets (mode Q)

#### Objets: Abondance

La **dissimilarit√© de Bray-Curtis** est asym√©trique. Elle est aussi appel√©e l'indice de Steinhaus, de Czekanowski ou de S√∏rensen. Il est important de s'assurer de bien s'entendre la m√©thode √† laquelle on fait r√©f√©rence. L'√©quation enl√®ve toute ambiguit√©. La dissimilarit√© de Bray-Curtis entre les points A et B est calcul√©e comme suit.

$$d_{AB} =  \frac {\sum \left| A_{i} - B_{i} \right| }{\sum \left(A_{i}+B_{i}\right)}$$

Utilisons `vegdist` pour g√©n√©rer les matrices d'association. Le format "liste" de R est pratique pour enregistrer la collection d'objets, dont les matrice d'association que nous allons cr√©er dans cette section.

```{r}
associations_abund <- list()
associations_abund[['BrayCurtis']] <- vegdist(abundance, method = "bray")
associations_abund[['BrayCurtis']]
```

La dissimilarit√© de Bray-Curtis est souvent utilis√©e dans la litt√©rature. Toutefois, la version originale de Bray-Curtis n'est pas tout √† fait m√©trique (semim√©trique). Cons√©quemment, la **dissimilarit√© de Ruzicka** (une variante de la dissimilarit√© de Jaccard pour les donn√©es d'abondance) est m√©trique, et devrait probablement √™tre pr√©f√©r√© √† Bary-Curtis ([Oksanen, 2006](http://ocw.um.es/ciencias/geobotanica/otros-recursos-1/documentos/vegantutorial.pdf)).

$$d_{AB, Ruzicka} =  \frac { 2 \times d_{AB, Bray-Curtis} }{1 + d_{AB, Bray-Curtis}}$$

```{r}
associations_abund[['Ruzicka']] <- associations_abund[['BrayCurtis']] * 2 / (1 + associations_abund[['BrayCurtis']])
```

La **dissimilarit√© de Kulczynski** (aussi √©crit Kulsinski) est asym√©trique et semim√©trique, tout comme celle de Bray-Curtis. Elle est calcul√©e comme suit.

$$d_{AB} = 1-\frac{1}{2} \times \left[ \frac{\sum min(A_i, B_i)}{\sum A_i} + \frac{\sum min(A_i, B_i)}{\sum B_i} \right]$$

```{r}
associations_abund[['Kulczynski']] <- vegdist(abundance, method = "kulczynski")
```

Une approche commune pour mesurer l'association entre sites d√©crits par des donn√©es d'abondance est la **distance de Hellinger**. Notez qu'il s'agit ici d'une distance, non pas d'une dissimilarit√©. Pour l'obtenir, on doit d'abord diviser chaque donn√©e d'abondance par l'abondance totale pour chaque site pour obtenir les esp√®ces en tant que proportions, puis on extrait la racine carr√©e de chaque √©l√©ment. Enfin, on calcule la distance euclidienne entre les proportions de chaque site. Pour rappel, une distance euclidienne est la g√©n√©ralisation en plusieurs dimensions du th√©or√®me de Pythagore, $c = \sqrt{a^2 + b^2}$.

$$D_{AB} = \sqrt {\sum \left( \frac{A_i}{\sum A_i} - \frac{B_i}{\sum B_i} \right)^2}$$

------------------ -----------------------------------------------
üò±\ **Attention**   La distance d'Hellinger h√©rite des biais li√©es aux donn√©es compositionnelles. Elle peut √™tre substiti√©e par une matrice de distances d'Aitchison.

------------------------------------------------------------------

```{r}
associations_abund[['Hellinger']] <- dist(decostand(abundance, method="hellinger"))
```

Toute comme la distance d'Hellinger, la **distance de chord** est calcul√©e par une distance euclidienne sur des donn√©es d'abondance transform√©es de sorte que chaque ligne ait une longueur (norme) de 1.

```{r}
associations_abund[['Chord']] <- dist(decostand(abundance, method="normalize"))
```

La **m√©trique du chi-carr√©**, ou $\chi$-carr√©, ou chi-square, donne davantage de poids aux esp√®ces rares qu'aux esp√®ces communes. Son utilisation est recommand√©e lorsque les esp√®ces rares sont de bons indicateurs de conditions √©cologiques particuli√®res ([Legendre et Legendre, 2012](https://www.elsevier.com/books/numerical-ecology/legendre/978-0-444-53868-0), p. 308).

$$  d_{AB} = \sqrt{\sum _j \frac{1}{\sum y_j} \left( \frac{A_j}{\sum A} - \frac{B_j}{\sum B} \right)^2 }  $$

La m√©trique peut √™tre transform√©e en distance en la multipliant par la racine carr√©e de la somme totale des esp√®ces dans la matric d'abondance ($X$).

$$ D_{AB} = \sqrt{\sum X} \times d_{AB} $$


```{r}
associations_abund[['ChiSquare']] <- dist(decostand(abundance, method="chi.square"))
```

Une manni√®re visuellement plus int√©ressante de pr√©senter une matrice d'association est un graphique de type *heatmap*.

```{r}
associations_abund_df <- list()

for (i in 1:length(associations_abund)) {
  associations_abund_df[[i]] <- data.frame(as.matrix(associations_abund[[i]]))
  colnames(associations_abund_df[[i]]) <- rownames(associations_abund_df[[i]])
  associations_abund_df[[i]]$row <- rownames(associations_abund_df[[i]])
  associations_abund_df[[i]] <- associations_abund_df[[i]] %>% gather(key=row)
  associations_abund_df[[i]]$column = rep(1:4, 4)
  associations_abund_df[[i]]$dist <- names(associations_abund)[i]
}
associations_abund_df <- do.call(rbind, associations_abund_df)

ggplot(associations_abund_df, aes(x=row, y=column)) +
  facet_wrap(. ~ dist, nrow = 2) +
  geom_tile(aes(fill = value)) +
  geom_text(aes(label = round(value, 2))) +
  scale_fill_gradient(low = "#46c19a", high = "#b94a73") +
  labs(x="Site", y="Site")
```

Peu importe le type d'association utilis√©e, les *heatmaps* montrent les m√™mes tendances. Les assocaitions de dissimilarit√© (Bray-Curtis, Kulczynski et Ruzicka) s'√©talent de 0 √† 1, tandis que les distances (Chi-Square, Chord et Hellinger) partent de z√©ro, mais n'ont pas de limite sup√©rieure. On note les plus grandes diff√©rences entre les sites 2 et 4, tandis que les sites 2 et 3 sont les plus semblables pour toutes les mesures d'association √† l'exception de la dissimilarit√© de Kulczynski.

#### Objets: Occurence (pr√©sence-absence)

Des indices d'association diff√©rents devraient √™tre utilis√©s lorsque des donn√©es sont compil√©es sous forme bool√©enne. En g√©n√©ral, les tableaux de donn√©es d'occurence seront compil√©s avec des 1 (pr√©sence) et des 0 (absence).

La **similarit√© de Jaccard** entre le site A et le site B est la proportion de double 1 (pr√©sences de 1 dans A et B) parmi les esp√®ces. La dissimilari√© est la proportion compl√©mentaire (comprenant [1, 0], [0, 1] et [0, 0]). La distance de Jaccard est la racine carr√©e de la dissimilarit√©.

```{r}
associations_occ <- list()
associations_occ[['Jaccard']] <- vegdist(occurence, method = "jaccard")
```

Les **distances d'Hellinger, de chord et de chi-carr√©** sont aussi appropri√©es pour les calculs de distances sur des tableaux d'occurence.


```{r}
associations_occ[['Hellinger']] <- dist(decostand(occurence, method="hellinger"))
associations_occ[['Chord']] <- dist(decostand(occurence, method="normalize"))
associations_occ[['ChiSquare']] <- dist(decostand(occurence, method="chi.square"))
```

Graphiquement,

```{r}
associations_occ_df <- list()

for (i in 1:length(associations_occ)) {
  associations_occ_df[[i]] <- data.frame(as.matrix(associations_occ[[i]]))
  colnames(associations_occ_df[[i]]) <- rownames(associations_occ_df[[i]])
  associations_occ_df[[i]]$row <- rownames(associations_occ_df[[i]])
  associations_occ_df[[i]] <- associations_occ_df[[i]] %>% gather(key=row)
  associations_occ_df[[i]]$column = rep(1:4, 4)
  associations_occ_df[[i]]$dist <- names(associations_occ)[i]
}
associations_occ_df <- do.call(rbind, associations_occ_df)

ggplot(associations_occ_df, aes(x=row, y=column)) +
  facet_wrap(. ~ dist) +
  geom_tile(aes(fill = value)) +
  geom_text(aes(label = round(value, 2))) +
  scale_fill_gradient(low = "#46c19a", high = "#b94a73") +
  labs(x="Site", y="Site")

```

Il est attendu que les matrices d'association sur l'occurence sont semblables √† celles sur l'abondance. Dans ce cas-ci, la distance d'Hellinger donne des r√©sultats semblables √† la dissimilarit√© de Jaccard.

#### Objets: Donn√©es quantitatives

Les donn√©es quantitative en √©cologie peuvent d√©crire l'√©tat de l'environnement: le climat, l'hydrologie, l'hydrog√©ochimie, la p√©dologie, etc. En r√®gle g√©n√©rale, les coordonn√©es des sites ne sot pas des variables environnementales, √† que l'on soup√ßonne la coordonn√©e elle-m√™me d'√™tre responsable d'effets sur notre syst√®me: mais il s'agira la plupart du temps d'effets confondants (par exemple, on peut mesurer un effet de lattitude sur le rendement des agrumes, mais il s'agira probablement avant tout d'effets dus aux conditions climatiques, qui elles changent en fonction de la lattitude). D'autre types de donn√©es quantitative pouvant √™tre appr√©hend√©es par des distances sont les traits ph√©nologiques, les ionomes, les g√©nomes, etc.

La **distance euclidienne** est la racine carr√©e de la somme des carr√©s des distances sur tous les axes. Il s'agit d'une application multidimensionnelle du th√©or√®me de Pythagore. La **distance d'Aitchison**, couverte dans le chapitre 6, est une distance euclidienne calcul√©e sur des donn√©es compositionnelles pr√©alablement transform√©es. La distance euclidienne est sensible aux unit√©s utilis√©s: utiliser des milim√®tres plut√¥t que des m√®tres enflera la distance euclidienne. Il est recommand√© de porter une attention particuli√®re aux unit√©s, et de standardiser les donn√©es au besoin (par exemple, en centrant la moyenne √† z√©ro et en fixant l'√©cart-type √† 1).

On pourrait, par exemple, mesurer la distance entre des observations des dimensions de diff√©rentes esp√®ces d'iris. Ce tableau est inclu dans R par d√©faut.

```{r}
data(iris)
iris %>% sample_n(5)
```

Les mesures du tableau sont en centim√®tres. Pour √©viter de donner davantage de poids aux longueur des s√©pales et en m√™me temps de n√©gliger la largeur des p√©tales, nous allons standardiser le tableau.

```{r}
iris_sc <- iris %>%
  select(-Species) %>% 
  scale(.) %>% 
  as_tibble(.)
iris_sc
```

Pour les comparaisons des dimensions, prenons la moyenne des dimensions (mises √† l'√©chelle) par esp√®ce.

```{r}
iris_means <- iris_sc %>%
  group_by(Species) %>%
  summarise_all(mean) %>%
  select(-Species)
iris_means
```

Nous pouvons utiliser la distance euclidienne, commune en g√©om√©trie, pour comparer les esp√®ces. La distance euclidienne est calcul√©e comme suit.


$$ \mathcal{E} = \sqrt{\Sigma_i \left( A_i - B_i \right) ^2 } $$

```{r}
associations_cont = list()
associations_cont[['Euclidean']] <- dist(iris_sc, method="euclidean")
```

La **distance de Mahalanobis** est semblable √† la distance euclidienne, mais qui tient compte de la covariance de la matrice des objets. Cette covariance peut √™tre utilis√©e pour d√©crire la structure d'un nuage de points. La figure suivante montre deux points verts qui se trouvent aux extr√™mes d'un nuage de point. Ces points ont des distances euclidiennes par rapport au centre diff√©rentes: les lignes d'√©quidistance eucl√©dienne sont trac√©es en rose. Toutefois, les deux points ont un distance de Mahalanobis √©gale √† partir du centre.

<img src="images/07_eucl-maha.png" width=400>
<p style="text-align: center">Source: [Parent et al. (2012)](https://www.intechopen.com/books/soil-fertility/nutrient-balance-as-paradigm-of-plant-and-soil-chemometricsnutrient-balance-as-paradigm-of-soil-and-).</p>

La diastance de Mahalanobis se calcule comme suit.

$$\mathcal{M} = \sqrt{(A - B)^T S^{-1} (A-B)}$$

Notez qu'il s'agit d'une g√©n√©ralisation de la distance euclidienne, qui √©quivaut √† une distance de Mahalanobis dont la matrice de covariance est une matrice identit√©.

La distance de Mahalanobis permet de repr√©senter des distances dans un espace fortement corr√©l√©. Elle est courramment utilis√©e pour d√©tecter les valeurs aberrantes selon des crit√®res de distance √† partir du centre d'un jeu de donn√©es multivari√©es.

```{r}
associations_cont[['Mahalanobis']] <- vegdist(iris_sc, 'mahalanobis')
```

La **distance de Manhattan** porte aussi le nom de distance de cityblock ou de taxi. C'est la distance que vous devrez parcourir pour vous rendre du point A au point B √† Manhattan, c'est-√†-dire selon une s√©quence de tron√ßons perpendiculaires.

$$ D_{AB} = \sum _i \left| A_i - B_i \right| $$

La distance de Manhattan est appropri√©e lorsque les gradients (changements d'un √©tat √† l'autre ou d'une r√©gion √† l'autre) ne permettent pas des changements simultan√©s. Mieux vaut standardiser les variables pour √©viter qu'une dimension soit pr√©pond√©rante.

```{r}
associations_cont[['Manhattan']] <- vegdist(iris_sc, 'manhattan')
```

Graphiquement

```{r}
associations_cont_df <- list()

for (i in 1:length(associations_cont)) {
  associations_cont_df[[i]] <- data.frame(as.matrix(associations_cont[[i]]))
  colnames(associations_cont_df[[i]]) <- rownames(associations_cont_df[[i]])
  associations_cont_df[[i]]$row <- rownames(associations_cont_df[[i]])
  associations_cont_df[[i]] <- associations_cont_df[[i]] %>% gather(key=row)
  associations_cont_df[[i]]$column = rep(1:nrow(iris), nrow(iris))
  associations_cont_df[[i]]$dist <- names(associations_cont)[i]
}
associations_cont_df <- do.call(rbind, associations_cont_df)

ggplot(associations_cont_df, aes(x=row, y=column)) +
  facet_wrap(. ~ dist) +
  geom_tile(aes(fill = value), colour = NA) +
  #geom_text(aes(label = round(value, 2))) +
  scale_fill_gradient(low = "#46c19a", high = "#b94a73") +
  labs(x="Site", y="Site")
```


