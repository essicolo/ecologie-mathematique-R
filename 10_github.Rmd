---
title: "Science ouverte et reproductibilitÃ©"
author: "Serge-Ã‰tienne Parent"
date: "`r format(Sys.Date())`"
output: github_document
---

# Science ouverte et reproductibilitÃ© {#chapitre-git}

***
ï¸\ **Objectifs spÃ©cifiques**:

Ã€ la fin de ce chapitre, vous

- saurez exprimer l'importance et les enjeux de la science ouverte
- saurez arranger vos donnÃ©es (format csv) et votre code (format notebook) afin de rendre vos recherches reproductibles
- saurez comment crÃ©er un dÃ©pÃ´t sur GitHub, puis administrer son dÃ©veloppement

***

```{r, echo=FALSE}
set.seed(645654)
```

La science ouverte favorise la diffusion des connaissances Ã  travers plusieurs aspects.

- **MÃ©thodologie ouverte**. Ce n'est pas pour rien que les revues scientifiques demandent de la minutie dans la description de la mÃ©thodologie: c'est pour s'assurer de bien comprendre la signification des donnÃ©es collectÃ©es et faire en sorte que vos donnÃ©es puissent Ãªtre Ã©chantillonnÃ©es de la mÃªme maniÃ¨re dans une potentielle expÃ©rience subsÃ©quente. Ã€ ce titre, la revue *Nature* a crÃ©Ã© le site de publication de protocoles expÃ©rimentaux [Protocol exchange](https://www.nature.com/protocolexchange/), "oÃ¹ la communautÃ© scientifique met en commun son savoir-faire expÃ©rimental pour accÃ©lÃ©rer la recherche" (ma traduction).
- **DonnÃ©es ouvertes**. En rendant nos donnÃ©es publiques, on permet Ã  la postÃ©ritÃ© de les utiliser pour amÃ©liorer les connaissances, dÃ©couvrir des structures qui nous avaient Ã©chappÃ©es, etc. Dans certains cas, l'ouverture des donnÃ©es peut Ãªtre contrainte par des enjeux lÃ©gaux (donnÃ©es privÃ©es) ou Ã©thiques (donnÃ©es pouvant Ãªtre utilisÃ©es Ã  mauvais escient). Dans la plupart des cas, les avantages surpassent largement les risques encourus par la publication des donnÃ©es, et les informations personnelles peuvent Ãªtre retirÃ©es. Des journaux comme Plos [exigent](https://blogs.plos.org/everyone/2014/02/24/plos-new-data-policy-public-access-data-2/) que les donnÃ©es minimales Ã  la reproduction de l'expÃ©rience soient fournies en tant que matÃ©riel supplÃ©mentaire.
- **Code source ouvert**. Les logiciels *open source*, comme R, sont gratuits pour la plupart. Cela permet Ã  quiconque de les utiliser, pourvu que l'on possÃ¨de le support matÃ©riel (un ordinateur) et une connection internet. De la mÃªme maniÃ¨re, le code R qui vous a permis de gÃ©nÃ©rer des rÃ©sultats Ã  partir de vos donnÃ©es peut Ãªtre rendu public sous toutes sortes de licenses *open source* peu restrictive (GPL, BSD, MIT, etc.). Avec les donnÃ©es et le code, vos travaux pourront Ãªtre reproduits.
- **RÃ©vision ouverte**. La rÃ©vision est un travail essentiel en science. Traditionnellement, les publications scientifiques sont rÃ©visÃ©s de maniÃ¨re anonyme, le but Ã©tant d'Ã©viter les conflits. RÃ©cemment, des revues comme [Frontiers](https://www.frontiersin.org/about/review-system) ont dÃ©ployÃ© des modes de rÃ©vision ouverts, permettant (1) des Ã©changes plus constructifs entre auteurs et rÃ©viseurs et (2) de remercier ouvertement la contribution des rÃ©viseurs Ã  l'article final.
- **AccÃ¨s ouvert**. Les Ã©diteurs scientifiques sont [largement critiquÃ©s](https://www.nature.com/articles/d41586-019-00492-4) pour demander des frais usuraires aux bibliothÃ¨ques et pour la consultation Ã  la piÃ¨ce, ainsi que des frais de publication dÃ©mesurÃ©s. En rÃ©action Ã  cela, le site [Sci-Hub](https://fr.wikipedia.org/wiki/Sci-Hub) dÃ©bloque gratuitement des millions d'articles scientifiques. Aussi, des journaux sÃ©rieux comme Plos et Frontiers publient *de facto* les articles sur leur site internet, de sorte qu'ils peuvent Ãªtre librement tÃ©lÃ©chargÃ©s.

Le manque d'ouverture dans la science a menÃ© plusieurs scientifiques Ã  parler d'une crise de la reproductibilitÃ© ([Baker, 2016](https://www.nature.com/news/1-500-scientists-lift-the-lid-on-reproducibility-1.19970)). Dans ce chapitre, nous verrons quelques astuces pour que R devienne un outil favorisant la science ouverte. Ã€ la fin de ce chapitre, vous devriez Ãªtre en mesure de dÃ©ployer votre code sur une archive en ligne, comme ceci.

```{r github-exemple, fig.align='center', fig.cap="Exemple d'un dossier de code et de donnÃ©es ouvertes, ([Jeanne et al. 2019]())", echo = FALSE}
knitr::include_graphics('images/10_github_exemple.png')
```

## Un code reproductible

```{r repre-code-bes, out.width='50%', fig.align='center', fig.cap="A Guide to Reproducible Code in Ecology and Evolution, [BES 2017](https://www.britishecologicalsociety.org/wp-content/uploads/2017/12/guide-to-reproducible-code.pdf)", echo = FALSE}
knitr::include_graphics('images/10_bes_frontpage.png')
```

La *British ecological society* offre des lignes guide pour crÃ©er un flux de travail reproductible ([BES, 2017](https://www.britishecologicalsociety.org/wp-content/uploads/2017/12/guide-to-reproducible-code.pdf)). En outre, les principes suivants doivent Ãªtre respectÃ©s (ma traduction).

- Commencez votre analyse Ã  partir d'une copie des donnÃ©es brutes.
- Toute opÃ©ration sur les donnÃ©es, que ce soit du nettoyage, des fusions, des transformations, etc. devrait Ãªtre effectuÃ©e avec du code, non pas manuellement.
- SÃ©parez vos opÃ©rations en unitÃ©s logiques thÃ©matiques. Par exemple, vous pourriez sÃ©parer votre code en parties: (i) charger, fusionner et nettoyer les donnÃ©es, (ii) analyser les donnÃ©es, (iii) crÃ©er des fichiers comme des tableaux et des figures.
- Ã‰liminez la duplication du code en crÃ©ant des fonctions personnalisÃ©es. Assurez-vous de commenter vos fonctions en dÃ©tails, expliquez ce qui est attendu comme entrÃ©es et comme sorties, ce qu'elles font et pourquoi.
- Documentez votre code et vos donnÃ©es Ã  mÃªme les feuilles de calcul ou dans un fichier de documentation sÃ©parÃ©.
- Tout fichier intermÃ©diaire devrait Ãªtre sÃ©parÃ© de vos donnÃ©es brutes.

### Structure d'un projet

Un projet de calcul devrait Ãªtre contenu en un seul dossier. Si vous n'avez que quelques projets, il est assez facile de garder l'info en mÃ©moire. Toutefois, en particulier en milieu d'entreprise, il se pourrait fort bien que vous ayez Ã  mener plusieurs projets de front. Certaines entreprises crÃ©ent des numÃ©ros de projet: vous aurez avantage Ã  nommer vos dossiers avec ces numÃ©ros, incluant une brÃ¨ve description. Pour ma part, j'ordonne mes projets chronologiquement par annÃ©e, avec un descriptif.

```
ğŸ“ 2019_abeille-canneberge
```

Notez que je n'utilise ni espace, ni caractÃ¨re spÃ©cial dans le nom du fichier, pour Ã©viter les erreurs potentielles avec des logiciels capricieux.

Ã€ l'intÃ©rieur du dossier racine du projet, j'inclus l'information gÃ©nÃ©rale: donnÃ©es source (souvent des fichiers Excel), manuscrit (mÃ©moire, thÃ¨se, article, etc.) documentation particuliÃ¨re (pour les articles, j'utilise Zotero, un gestionnaire de rÃ©fÃ©rence), photos et, Ã©videmment, mon dossier de code (par exemple `rstats`).

```

ğŸ“ 2019_abeille-canneberge
|-ğŸ“ documentation
|-ğŸ“ manuscrit
|-ğŸ“ photos
|-ğŸ“ rstats
|-ğŸ“ source

```

Si vous rÃ©digez votre manuscrit Ã  mÃªme votre code (en Latex, markdown ou R markdown - nous verrons cela plus loin), vous pouvez trÃ¨s bien l'inclure dans votre fichier de calcul.

Ã€ l'intÃ©rieur du fichier de calcul, vous aurez votre projet RStudio et vos feuilles de calcul sÃ©quencÃ©es. J'utilise `01-`, et non pas `1-` pour Ã©viter que le `10-` suive le `1-` dans le classement en ordre alpha-numÃ©rique au cas oÃ¹ j'aurais plus de 10 feuilles de calcul. J'inclus un fichier `README.md` (extension md pour markdown), qui contient les informations gÃ©nÃ©rales de mes calculs. Les donnÃ©es brutes (`csv`) sont placÃ©es dans un dossier `data`, mes graphiques sont exportÃ©s dans un dossier `image`, mes tableaux sont exportÃ©s dans un dossier `tables` et mes fonctions externes sont exportÃ©es dans un dossier `lib`.

```

ğŸ“ rstats
|-ğŸ“ data
|-ğŸ“ images
|-ğŸ“ lib
|-ğŸ“ tables
ğŸ“„ bees.Rproj
ğŸ“„ 01_clean-data.R
ğŸ“„ 02_data-mining.R
ğŸ“„ 03_data-analysis.R
ğŸ“„ 04_data-modeling.R
ğŸ“„ README.md

```

Je dÃ©cris les noms de fichiers dans la langue de communication utile pour le rendu final du projet, souvent en anglais lors de publications acadÃ©miques. J'Ã©vite les noms de fichier qui ne sont pas informatifs, par exemple `01.R` ou `Rplot1.png`, ainsi que les majuscules, les caractÃ¨res spÃ©ciaux et les espaces comme dans `DeuxiÃ¨me essai.R` (le `README.md` est une exception).

Pour partager un dossier de projet sur R, on n'a qu'Ã  le compresser (*zip*), puis l'envoyer. Pour que le code fonctionne sur un autre ordinateur, les liens vers les fichiers de donnÃ©es Ã  importer ou les graphiques exportÃ©s doivent Ãªtre relatifs au fichier R ouvert dans votre projet, non pas le chemin complet sur votre ordinateur.

```{r rel-link-allison-horst, out.width='100%', fig.align='center', fig.cap="Retrouvez votre chemin, dessin de [Allison Horst](https://github.com/allisonhorst/stats-illustrations)", echo = FALSE}
knitr::include_graphics('https://raw.githubusercontent.com/allisonhorst/stats-illustrations/master/rstats-artwork/here.png')
```

### Le format [R markdown](https://rmarkdown.rstudio.com/)

Un code reproductible est un code bien dÃ©crit. La structure de projet prÃ©sentÃ©e prÃ©cÃ©demment propose de segmenter le code en plusieurs fichiers R. Cette maniÃ¨re de procÃ©der est optionnelle. Si le fichier de calcul n'est pas trop encombrant, on pourra n'en utiliser qu'un seul, par exemple `stats.R`. Ã€ l'intÃ©rieur mÃªme des feuilles de calcul R, vous devrez commenter votre code pour en expliquer les Ã©tapes, par exemple:

```
#############
## Titre 1 ##
#############

# Titre 2
## Titre 3
data <- read_csv("data/abeilles.csv") # commentaire particulier

```

RStudio a dÃ©veloppÃ© une approche plus conviviale avec son format **R markdown**. Le langage [*markdown*](https://daringfireball.net/projects/markdown/basics) permet de formater un texte avec un minimum de dÃ©corations, et R markdown permet d'intÃ©grer du texte et des codes. Ces notes de cours sont par ailleurs entiÃ¨rement Ã©crites en R markdown.

#### Le langage markdown

Un fichier portant l'extension `.md` ou `.markdown` est un fichier texte clair (que vous pouvez ouvrir et Ã©diter dans n'importe votre Ã©diteur texte prÃ©fÃ©rÃ©), tout comme un fichier `.R`. Il existe nÃ©anmoins de nombreux Ã©diteurs de texte spÃ©cialisÃ©s en Ã©dition markdown - mon prÃ©fÃ©rÃ© est [Zettlr](https://www.zettlr.com/). Les dÃ©corations principales en markdown sont les suivantes (les citations utilisÃ©es ci-aprÃ¨s sont tirÃ©es du roman Dune, de Frank Herbert).

**Italique**. Pour emphaser en italique, balisez le texte avec des astÃ©risques. Par exemple, "`Pourrais-je porter parmi vous le nom de *Paul-Muad'dib*?`" devient "Pourrais-je porter parmi vous le nom de *Paul-Muad'dib*?"

**Gras**. Pour emphaser en gras, balisez le texte avec des doubles astÃ©risques. Par exemple, "`L'espÃ©rance **ternit** l'observation.`" devient "L'espÃ©rance **ternit** l'observation".

**Largeur fixe**. Pour un texte Ã  largeur fixe (signifiant du code), balisez le texte avec des accents graves. Par exemple, "``Quel nom donnez-vous Ã  la petite `souris`, celle qui saute ?``" devient "Quel nom donnez-vous Ã  la petite `souris`, celle qui saute?"

**Listes**. Pour effectuer une liste numÃ©rotÃ©e, utilisez le chiffre `1.` Par exemple,

```

1. Paul
1. Leto
1. Alia

```

devient

1. Paul
1. Jessica
1. Alia

De mÃªme, pour une liste Ã  puces, changez le `1.` par le `- ` ou le `* `.

**EntÃªtes**. Les titres sont prÃ©cÃ©dÃ©s par des `#`. Un `# ` pour un titre 1, deux `## ` pour un titre 2, etc. Par exemple,

```

# Imperium
## Landsraad
### Maison des AtrÃ©ides
### Maison des Harkonnen
## CHOAM
# Guilde des navigateurs

```

InsÃ©rera les titres appropriÃ©s (que je n'insÃ¨re pas pour ne pas bousiller la structure de ce texte).

**Liens**. Pour insÃ©rer des liens, le texte est entre crochet directement suivi du lien entre parenthÃ¨ses. Par exemple, "`Longue vie aux [combattants](https://youtu.be/Cv87NJ2xX0k?t=59)`" devient "Longue vie aux [combattants](https://youtu.be/Cv87NJ2xX0k?t=59)".

**Ã‰quations**. Les Ã©quations suivent la syntaxe Latex entre deux `$$` pour les Ã©quations sur une ligne et entre des doubles `$$$$` pour les Ã©quations sur un paragraphe. Par exemple, `$c = \sqrt{a^2 + b^2}$` devient $c = \sqrt{a^2 + b^2}$.

**Images**. Pour insÃ©rer une image, `![nom de l'image](images/spice-must-flow.png)`.

Une liste exhaustive des balises markdown est disponible sous forme d'[aide-mÃ©moire](https://github.com/adam-p/markdown-here/wiki/Markdown-Cheatsheet).

#### R markdown

Dans RStudio, ouvrez un R markdown par `File > New file > R Markdown`. Si le module **`rmarkdown`** n'est pas installÃ©, RStudio vous demandera de l'installer. Une fenÃªtre apparaÃ®tra.

```{r r-md-new-file, out.width='100%', fig.align='center', fig.cap="Nouveau fichier R markdown", echo = FALSE}
knitr::include_graphics('images/10_file-new-rmarkdown.png')
```

Les options d'exportation pourront Ãªtre modifiÃ©es par la suite.

Un fichier d'exemple sera crÃ©Ã©, et vous pourrez le modifier. Les parties de texte sont Ã©crits en markdown, et le code R est enchÃ¢ssÃ© entre les balises ```` ```{r} ```` et ```` ``` ````. Je nommerai ces parties de code des *cellules* de code.

Des options de code l'intÃ©rieur peuvent Ãªtre utilisÃ©es Ã  l'intÃ©rieur des accolades `{r}`. Par exemple

- `{r, filtre-outliers}` donne le nom `filtre-outliers` au bloc de code, qui permet nommÃ©ment de nommer les images crÃ©er dans le bloc de code.
- `{r, eval = FALSE}` permet d'activer (`TRUE`, valeur par dÃ©faut) ou de dÃ©sactiver (`FALSE`) le calcul de la cellule.
- `{r, echo = FALSE}` permet de n'afficher que la sortie de la cellule de code en n'affichant pas le code, par exemple un graphique ou le sommaire d'une rÃ©gression.
- `{r, results = FALSE}` permet de n'afficher que le code, mais pas la sortie.
- `{r, warning = FALSE, message = FALSE, error = FALSE}` n'affichera pas les avertissements, les messages automatiques et les messages d'erreur.
- `{r, fig.width = 10, fig.height = 5, fig.align = "center"}` affichera les graphiques dans les dimensions voulues, alignÃ©e au centre (`"center"`), Ã  gauche (`"left"`) ou Ã  droite (`"right"`).

Notez que vous pouvez exÃ©cuter rapidement du code sur une ligne avec la formulation ``` `r ` ```, par exemple ```la moyenne des nombres `\r a<-round(runif(4, 0, 10)); a` est de `\r mean(a)` ```, en enlevant les `\` devant les `r` (ajoutÃ©es artificiellement pour Ã©viter que le code soit calculÃ©) sera la moyenne des nombres `r a<-round(runif(4, 0, 10)); a` est de `r mean(a)`

Une fois que vous serez satisfait de votre document, cliquer sur `Knit` ![](images/10_knit-button.png) et le fichier de sortie sera gÃ©nÃ©rÃ©. Le guide qui permet de gÃ©nÃ©rer le fichier de sortie est tout en haut du fichier. Nous l'appelons le YAML (acronyme rÃ©cursif de *YAML Ain't Markup Language*). Prenez le YAML suivant.

```
---
title: "Dune"
author: "Frank Herbert"
date: "1965-08-01"
output: github_document
---
```

Le titre, l'auteur et la date sont spÃ©cifiÃ©es. Pour indiquer la date courante, on peut simplement la gÃ©nÃ©rer avec R en remplaÃ§ant `"1965-08-01"` par `r format(Sys.Date())`. La spÃ©cification `output` indique le type de document Ã  gÃ©nÃ©rer, par exemple `html_document` pour une page web, `pdf_document` pour un pdf, ou `word_document` pour un docx. Dans ce cas-ci, j'indique `github_document` pour crÃ©er un fichier markdown comprenant nommÃ©ment des liens relatifs vers les images des graphiques gÃ©nÃ©rÃ©s. Pourquoi un `github_document`? C'est le sujet de la prochaine sous-section. Mais avant cela, je vous rÃ©fÃ¨re Ã  un autre aide-mÃ©moire.

```{r r-md-cs, out.width='100%', fig.align='center', fig.cap="[Aide-mÃ©moire pour R Markdown, Source: RStudio](https://github.com/rstudio/cheatsheets/raw/master/rmarkdown-2.0.pdf)", echo = FALSE}
knitr::include_graphics('https://www.rstudio.com/wp-content/uploads/2018/08/rmarkdown-2.0-600x464.png')
```

## Introduction Ã  GitHub

Le system de suivi de version `git` (*open source*) a Ã©tÃ© crÃ©Ã© par Linus Torvalds, aussi connu pour avoir crÃ©Ã© Linux. `git` prend une photo de votre rÃ©pertoire de projet Ã  chaque fois que vous *commettez* un changement. Vous pourrez revenir sans problÃ¨me sur d'anciennes versions si quelque chose tourne mal, et vous pourrez publier le rÃ©sultat final sur un service d'hÃ©bergement utilisant `git`.

Il existe plusieurs services pour rendre `git` utilisable en ligne, mais GitHub est dÃ©finitivement le plus utilisÃ© d'entre tous. La plateforme [GitHub](https://github.com/) est presque devenue un rÃ©seau social de dÃ©veloppement. GitHub, maintenant la propriÃ©tÃ© de Microsoft, n'est en soi pas open source. Si cela vous pose problÃ¨me, je vous redirige vers la plateforme open source [GitLab](https://about.gitlab.com/), qui fonctionne Ã  peu prÃ¨s de la mÃªme maniÃ¨re que GitHub (alors que la plateforme GitHub sera fort probablement toujours vivante dans plusieurs annÃ©es, on en est moins sÃ»r pour GitLab, c'est pourquoi j'utilise [GitHub](https://github.com/essicolo) Ã  des fins professionnelles mais j'utilise [GitLab](gitlab.com/essicolo) Ã  des fins personnelles).

Pour suivre cette partie, je vous invite Ã  [crÃ©er un compte sur GitHub](https://github.com/join?source=header-home) ou [GitLab](https://gitlab.com/users/sign_in?redirect_to_referer=yes&nav_source=navbar), Ã  votre choix. CrÃ©ez un nouveau dÃ©pÃ´t (*New repository*).

```{r github-new-repo, out.width='100%', fig.align='center', fig.cap="Nouveau dÃ©pÃ´t avec GitHub", echo = FALSE}
knitr::include_graphics('images/10_github-new-repo.gif')
```

```{r gitlab-new-repo, out.width='100%', fig.align='center', fig.cap="Nouveau dÃ©pÃ´t avec GitLab", echo = FALSE}
knitr::include_graphics('images/10_gitlab-new-repo.gif')
```

Pour utiliser `git`, vous pourrez toujours travailler en ligne de commande, mais je vous suggÃ¨re d'utiliser [GitHub desktop](https://desktop.github.com/) (qui fonctionne aussi sur GitLab). Github desktop ([ou tout auter logiciel de gestion de `git`](https://alternativeto.net/software/github-desktop/)) vous permettra d'abord de *cloner* un rÃ©pertoire en ligne. Le clonage vous permet de crÃ©er une copie locale du rÃ©pertoire.

```{r github-clone-repo, out.width='100%', fig.align='center', fig.cap="Cloner dÃ©pÃ´t avec GitHub", echo = FALSE}
knitr::include_graphics('images/10_github-clone-repo.gif')
```

```{r gitlab-clone-repo, out.width='100%', fig.align='center', fig.cap="Cloner dÃ©pÃ´t avec GitLab", echo = FALSE}
knitr::include_graphics('images/10_gitlab-clone-repo.gif')
```

Une fois que le dÃ©pÃ´t est clonÃ©, il est sur voter ordinateur. Lorsque vous effectuez un changement, vous devez commettre (*commit*), puis envoyer (*push*) vos changements vers le dÃ©pÃ´t en ligne. Pour que votre document markdown soit lisible par GitHub et GitLab, il doit Ãªtre exportÃ© sous forme de `github_document`. Un fichier `.md` sera crÃ©Ã©, et inclura les dÃ©tails de votre document de calculs.

```{r github-push-repo, out.width='100%', fig.align='center', fig.cap="Â«Commettre et dÃ©ployer un dÃ©pÃ´t avec GitHub", echo = FALSE}
knitr::include_graphics('images/10_github-push.gif')
```

L'interface de GitHub Desktop vous permet de revenir en arriÃ¨re en Ã©liminant des *commits* prÃ©cÃ©dents.

```{r github-revert, out.width='100%', fig.align='center', fig.cap="Â«Revenir en arriÃ¨re avec GitHub desktop", echo = FALSE}
knitr::include_graphics('images/10_github-revert.png')
```

Vous pourrez ajouter des collaborateurs Ã  votre dÃ©pÃ´t, pour que plusieurs personnes travaillent de front sur un mÃªme dÃ©pÃ´t. Il est aussi possible de crÃ©er une branche d'un dÃ©pÃ´t, fusionner la branche de dÃ©veloppement avec la branche principale, commenter les codes, suggÃ©rer des changements, etc., mais cela sort du cadre d'un cours sur la reproductibilitÃ©.

## Introduction Ã  Pakrat
